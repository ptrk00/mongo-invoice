<h1>Invoice Management</h1>
<strong>Invoice Details:</strong>
<pre><%= JSON.stringify(invoice, null, 2) %></pre>
</br>
<% if (invoice.items && invoice.items.length > 0) { %>
    <h2>Items</h2>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Description</th>
                <th>Quantity</th>
                <th>Unit Price</th>
                <th>Discount</th>
                <th>Total Price</th>
            </tr>
        </thead>
        <tbody>
            <% invoice.items.forEach(function(item) { %>
                <tr>
                    <td><%= item.description %></td>
                    <td><%= item.quantity %></td>
                    <td><%= item.unitPrice %></td>
                    <td><%= item.discount %></td>
                    <td><%= item.totalPrice %></td>
                </tr>
            <% }); %>
        </tbody>
    </table>

    <button class="btn btn-primary" onclick="showAddItemForm('<%= invoice._id %>')">Add Item</button>
    <div id="addItemForm-<%= invoice._id %>" style="display:none;">
        <h4>Add New Item</h4>
        <form onsubmit="submitNewItem(event, '<%= invoice._id %>')">
            <div class="form-group">
                <label for="description">Description</label>
                <input type="text" class="form-control" id="description-<%= invoice._id %>" placeholder="Consulting Service">
            </div>
            <div class="form-group">
                <label for="quantity">Quantity</label>
                <input type="number" class="form-control" id="quantity-<%= invoice._id %>" placeholder="10">
            </div>
            <div class="form-group">
                <label for="unitPrice">Unit Price</label>
                <input type="number" class="form-control" id="unitPrice-<%= invoice._id %>" placeholder="100" step="0.01">
            </div>
            <div class="form-group">
                <label for="discount">Discount</label>
                <input type="number" class="form-control" id="discount-<%= invoice._id %>" placeholder="0" step="0.01">
            </div>
            <button type="submit" class="btn btn-success">Submit</button>
        </form>
    </div>
<% } %>

</br>
<% if (invoice.tax && invoice.tax.length > 0) { %>
    <h2>Taxes</h2>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Tax Name</th>
                <th>Tax Rate</th>
                <th>Tax Amount</th>
                <th>Jurisdiction ID</th>
            </tr>
        </thead>
        <tbody>
            <% invoice.tax.forEach(function(tax) { %>
                <tr>
                    <td><%= tax.taxName %></td>
                    <td><%= tax.taxRate %></td>
                    <td><%= tax.taxAmount %></td>
                    <td><%= tax.jurisdictionId %></td>
                </tr>
            <% }); %>
        </tbody>
    </table>
<% } %>
</br>
<% if (invoice.payments && invoice.payments.length > 0) { %>
    <h2>Payments</h2>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Payment ID</th>
                <th>Amount</th>
                <th>Payment Date</th>
                <th>Payment Method</th>
                <th>Transaction ID</th>
                <th>Processor ID</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            <% invoice.payments.forEach(function(payment) { %>
                <tr>
                    <td><%= payment.paymentId %></td>
                    <td><%= payment.amount %></td>
                    <td><%= payment.paymentDate.toISOString().slice(0, 10) %></td>
                    <td><%= payment.paymentMethod %></td>
                    <td><%= payment.transactionId %></td>
                    <td><%= payment.processorId %></td>
                    <td><%= payment.notes %></td>
                </tr>
            <% }); %>
        </tbody>
    </table>
<% } %>

<script>
    function showAddItemForm(invoiceId) {
        document.getElementById('addItemForm-' + invoiceId).style.display = 'block';
    }

    async function submitNewItem(event, invoiceId) {
        event.preventDefault();

        const description = document.getElementById('description-' + invoiceId).value;
        const quantity = document.getElementById('quantity-' + invoiceId).value;
        const unitPrice = document.getElementById('unitPrice-' + invoiceId).value;
        const discount = document.getElementById('discount-' + invoiceId).value;

        const newItem = {
            description: description,
            quantity: parseFloat(quantity),
            unitPrice: Number(parseFloat(unitPrice)),
            discount: Number(parseFloat(discount))
        };

        try {
            const response = await fetch(`/invoices/${invoiceId}/items`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newItem)
            });

            if (response.ok) {
                location.reload();
            } else {
                alert('Failed to add item');
            }
        } catch (error) {
            console.error('Error adding item:', error);
            alert('Error adding item');
        }
    }
</script>